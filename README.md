# poll-story-telegram-bot
 
## Описание

Этот скрипт предназначен для автоматической публикации опросов в Telegram-канале, создавая интерактивную историю.
Бот сделан [Denis Sexy IT](http://t.me/denissexy).

### Как это работает

1.  Скрипт начинает историю с предопределенной фразы (`INITIAL_STORY_IDEA`), указанной в коде `telegram_poster.py`.
2.  Он отслеживает текущий текст истории и ID последнего опроса с помощью файла `story_state.json`.
3.  При каждом запуске (после первого) скрипт определяет победивший вариант в последнем опросе.
4.  Используя API OpenAI, скрипт генерирует продолжение истории на основе предыдущего текста и выбранного варианта.
5.  Новая часть истории публикуется в канале.
6.  Затем OpenAI генерирует 4 варианта для нового опроса, который также публикуется в канале.

### Сброс состояния истории

Чтобы начать историю заново или исправить ошибки, удалите файл `story_state.json`. При следующем запуске скрипт начнет публикацию с самого начала `INITIAL_STORY_IDEA`.

### Хостинг и запуск

Скрипт рассчитан на запуск на VPS (виртуальном частном сервере) или любом другом сервере, который может выполнять задачи по расписанию. Рекомендуется использовать `cron` для регулярного запуска скрипта (например, каждые 30 минут или каждый час, в зависимости от желаемой частоты публикаций).

Пример команды для `crontab`:
```bash
*/30 * * * * cd /path/to/your/script/directory && /usr/bin/python3 telegram_poster.py >> /path/to/your/logfile.log 2>&1
```
*Замените `/path/to/your/script/directory` на реальный путь к папке со скриптом.*
*Замените `/usr/bin/python3` на ваш путь к интерпретатору Python 3.*
*Замените `/path/to/your/logfile.log` на путь к файлу логов.*

### Установка зависимостей

Перед первым запуском скрипта необходимо установить все требуемые библиотеки Python. Перейдите в каталог проекта и выполните команду:

```bash
pip install -r requirements.txt
```
*Убедитесь, что у вас установлен `pip` для Python 3.*

### Требования

1.  **Создайте Telegram-бота**: Используйте BotFather в Telegram для создания нового бота. Вы получите токен API, который понадобится для скрипта.
2.  **Добавьте бота в канал**: Бот должен быть добавлен в ваш Telegram-канал как администратор с правами на отправку сообщений и создание опросов.
3.  **Настройте `telegram_poster.py`**: (Для смелых) Укажите ваш API токен бота (`BOT_TOKEN`), ID вашего канала (`CHANNEL_ID`) и ваш ключ OpenAI API (`OPENAI_API_KEY`) непосредственно в файле `telegram_poster.py` в соответствующих переменных. **Модель OpenAI**: По умолчанию используется `gpt-4.1` (задана в переменной `OPENAI_MODEL`), так как она хорошо пишет, поддерживает необходимые функции (strict function calling) и контекстное окно в 1М токенов (скрипт каждый раз передает целую историю в запрос). Вы можете изменить модель, отредактировав эту переменную, но убедитесь, что выбранная модель совместима с используемыми функциями API, иначе скрипт может работать некорректно.

## Использование другого API-провайдера (OpenAI-совместимого)

Скрипт позволяет использовать не только официальное API OpenAI, но и другие совместимые API.

Для этого необходимо задать две переменные окружения перед запуском скрипта:

1.  `OPENAI_API_KEY`: Ваш API-ключ от провайдера.
2.  `OPENAI_BASE_URL`: Базовый URL API-эндпоинта вашего провайдера (например, `https://api.yourprovider.com/v1`).

Пример установки переменных и запуска скрипта в терминале (Linux/macOS):

```bash
export OPENAI_API_KEY="ВАШ_API_КЛЮЧ"
export OPENAI_BASE_URL="URL_ВАШЕГО_ПРОВАЙДЕРА"
python telegram_poster.py
```

Если `OPENAI_BASE_URL` не установлена, скрипт будет по умолчанию использовать `https://api.openai.com/v1`.
